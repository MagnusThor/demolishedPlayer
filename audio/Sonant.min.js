var SonantPLayer=function(){function SonantPLayer(song){this.song=song,this.WAVE_SPS=44100,this.WAVE_CHAN=2,this.generate=function(track){var oscillators=[this.osc_sin,this.osc_square,this.osc_saw,this.osc_tri],i,j,k,b,p,row,n,currentpos,cp,c1,c2,q,low,band,high,t,lfor,e,x,rsample,f,da,o1t,o2t,chnBuf=this.chnBufWork,mixBuf=this.mixBufWork,waveSamples=this.WAVE_SIZE,waveBytes=this.WAVE_SIZE*this.WAVE_CHAN*2,instr=this.song.songData[track],rowLen=this.song.rowLen,osc_lfo=oscillators[instr.lfo_waveform],osc1=oscillators[instr.osc1_waveform],osc2=oscillators[instr.osc2_waveform],attack=instr.env_attack,sustain=instr.env_sustain,release=instr.env_release,panFreq=Math.pow(2,instr.fx_pan_freq-8)/rowLen,lfoFreq=Math.pow(2,instr.lfo_freq-8)/rowLen;for(b=0;b<waveBytes;b+=2)chnBuf[b]=0,chnBuf[b+1]=128;for(currentpos=0,p=0;p<this.song.endPattern-1;++p)for(cp=instr.p[p],row=0;row<32;++row){if(cp&&(n=instr.c[cp-1].n[row]))for(c1=c2=0,o1t=this.getnotefreq(n+12*(instr.osc1_oct-8)+instr.osc1_det)*(1+8e-4*instr.osc1_detune),o2t=this.getnotefreq(n+12*(instr.osc2_oct-8)+instr.osc2_det)*(1+8e-4*instr.osc2_detune),q=instr.fx_resonance/255,low=band=0,j=attack+sustain+release-1;j>=0;--j){switch(lfor=osc_lfo((k=j+currentpos)*lfoFreq)*instr.lfo_amt/512+.5,e=1,j<attack?e=j/attack:j>=attack+sustain&&(e-=(j-attack-sustain)/release),t=o1t,instr.lfo_osc1_freq&&(t+=lfor),instr.osc1_xenv&&(t*=e*e),rsample=osc1(c1+=t)*instr.osc1_vol,t=o2t,instr.osc2_xenv&&(t*=e*e),rsample+=osc2(c2+=t)*instr.osc2_vol,instr.noise_fader&&(rsample+=(2*Math.random()-1)*instr.noise_fader*e),rsample*=e/255,f=instr.fx_freq,instr.lfo_fx_freq&&(f*=lfor),band+=(f=1.5*Math.sin(3.141592*f/this.WAVE_SPS))*(high=q*(rsample-band)-(low+=f*band)),instr.fx_filter){case 1:rsample=high;break;case 2:rsample=low;break;case 3:rsample=band;break;case 4:rsample=low+high}t=this.osc_sin(k*panFreq)*instr.fx_pan_amt/512+.5,rsample*=39*instr.env_master,x=chnBuf[k<<=2]+(chnBuf[k+1]<<8)+rsample*(1-t),chnBuf[k]=255&x,chnBuf[k+1]=x>>8&255,x=chnBuf[k+2]+(chnBuf[k+3]<<8)+rsample*t,chnBuf[k+2]=255&x,chnBuf[k+3]=x>>8&255}currentpos+=rowLen}for(p=instr.fx_delay_time*rowLen>>1,t=instr.fx_delay_amt/255,n=0;n<waveSamples-p;++n)b=4*n,x=chnBuf[k=4*(n+p)]+(chnBuf[k+1]<<8)+(chnBuf[b+2]+(chnBuf[b+3]<<8)-32768)*t,chnBuf[k]=255&x,chnBuf[k+1]=x>>8&255,x=chnBuf[k+2]+(chnBuf[k+3]<<8)+(chnBuf[b]+(chnBuf[b+1]<<8)-32768)*t,chnBuf[k+2]=255&x,chnBuf[k+3]=x>>8&255;for(b=0;b<waveBytes;b+=2)x=mixBuf[b]+(mixBuf[b+1]<<8)+chnBuf[b]+(chnBuf[b+1]<<8)-32768,mixBuf[b]=255&x,mixBuf[b+1]=x>>8&255},this.WAVE_SIZE=this.WAVE_SPS*song.songLen;var size=Math.ceil(Math.sqrt(this.WAVE_SIZE*this.WAVE_CHAN/2)),ctx=document.createElement("canvas").getContext("2d");this.chnBufWork=ctx.createImageData(size,size).data;var b,mixBuf=ctx.createImageData(size,size).data;for(b=size*size*4-2;b>=0;b-=2)mixBuf[b]=0,mixBuf[b+1]=128;this.mixBufWork=mixBuf}return SonantPLayer.prototype.play=function(){},SonantPLayer.prototype.createAudio=function(settings){var _this=this,b,k,x,wave,l1,l2,s,y,mixBuf=this.mixBufWork,waveBytes=this.WAVE_SIZE*this.WAVE_CHAN*2;for(this.chnBufWork=null,l2=(l1=waveBytes-8)-36,wave=String.fromCharCode(82,73,70,70,255&l1,l1>>8&255,l1>>16&255,l1>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&l2,l2>>8&255,l2>>16&255,l2>>24&255),b=0;b<waveBytes;){for(x="",k=0;k<256&&b<waveBytes;++k,b+=2)y=(y=4*(mixBuf[b]+(mixBuf[b+1]<<8)-32768))<-32768?-32768:y>32767?32767:y,x+=String.fromCharCode(255&y,y>>8&255);wave+=x}s="data:audio/wav;base64,"+btoa(wave),wave=null;var audioCtx=new AudioContext,audioEl=new Audio,onLoad;audioEl.preload="auto",audioEl.crossOrigin="anonymous",audioEl.src=s,source=audioCtx.createMediaElementSource(audioEl),_this.audio=audioEl;var source},SonantPLayer.prototype.osc_sin=function(value){return Math.sin(6.283184*value)},SonantPLayer.prototype.osc_square=function(value){return this.osc_sin(value)<0?-1:1},SonantPLayer.prototype.osc_saw=function(value){return value%1-.5},SonantPLayer.prototype.osc_tri=function(value){var v2=value%1*4;return v2<2?v2-1:3-v2},SonantPLayer.prototype.getnotefreq=function(n){return.00390625*Math.pow(1.059463094,n-128)},SonantPLayer.prototype.getData=function(t,n){for(var i=Math.floor(t*this.WAVE_SPS),j=0,d=[],b=this.mixBufWork;j<2*n;j+=2){var k=4*(i+j)+1;d.push(t>0&&k<b.length?(b[k]+b[k-1]/256)/256:.5)}return d},SonantPLayer}();